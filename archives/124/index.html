<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>简单讲一下使用MS3D为opengl建模  &middot; 悟剑阁</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="3d, opengl, ">


<meta property="og:title" content="简单讲一下使用MS3D为opengl建模  &middot; 悟剑阁 ">
<meta property="og:site_name" content="悟剑阁"/>
<meta property="og:url" content="http://blog.sword865.com/archives/124" />
<meta property="og:locale" content="zh-CN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2011-03-16T00:00:00Z" />
<meta property="og:article:modified_time" content="2011-03-16T00:00:00Z" />

  
    
<meta property="og:article:tag" content="3d">
    
<meta property="og:article:tag" content="opengl">
    
  

  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "简单讲一下使用MS3D为opengl建模",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2011-03-16",
    "description": "",
    "wordCount":  2157 
  }
</script>



<link rel="canonical" href="http://blog.sword865.com/archives/124" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.sword865.com/touch-icon-144-precomposed.png">
<link href="http://blog.sword865.com/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.16" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://blog.sword865.com/css/font-awesome.min.css">
<link rel="stylesheet" href="http://blog.sword865.com/css/style.css">
<link rel="stylesheet" href="http://blog.sword865.com/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://blog.sword865.com/">
  悟剑阁

</a>

</div>

  
<div class="container topline">
  
  阁中悟剑，红尘练心


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="http://blog.sword865.com/about">关于我</a>

<a href="http://blog.sword865.com/categories" title="Show list of categories">分类</a>

<a href="http://blog.sword865.com/post" title="Show list of posts">我的文章</a>

<a href="http://blog.sword865.com/tags" title="Show list of tags">标签列表</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:luosha865@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/luosha865">
  <span class="fa fa-github-square"></span><span>github</span></a>





















</div>


  
<iframe id="youdaosearch" border="0" vspace="0" hspace="0" marginwidth="0" marginheight="0" framespacing="0" frameborder="0" scrolling="no" width="225" height="40" src="http://toolbox.youdao.com/searchcode/iframe?style=4&product=site&product=web&defaultProduct=site&borderColor=ffffff&bkColor=2053ab&formWidth=220&domain=blog.sword865.com"></iframe>

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>简单讲一下使用MS3D为opengl建模
</h1>

  <div class="metas">
<time datetime="2011-03-16">16 Mar, 2011</time>


  
    &middot; by luosha865
  
  &middot; Read in about 5 min
  &middot; (2157 Words)
  <br>
  
<a class="label" href="http://blog.sword865.com/tags/3d">3d</a>

<a class="label" href="http://blog.sword865.com/tags/opengl">opengl</a>



</div>

</header>

  <div class="container content">
  <p>做毕设的时候写的东西，贴上来吧…………</p>

<p>由于在OPENGL只能通过程序语言绘制模型，远不能达到可见既可得的目的。因此，比起3DMAX、MAYA等可视化3D建模工具，OPENGL模型的建立就相当的困难，为了简化这一问题的处理，可以使用简单小巧的MS3D来完成可见即可得的绘制过程。</p>

<p>MS3D的文件有着非常简单良好的文件结构，可从该文件中完美读取在可视工具中绘制的3D图形模型包含的点、线、面等各项基本结构的参数与位置，并在OPENGL根据读取结果即可进行绘制重现该模型。</p>

<p>MS3D全名为MilkShape3D，是一款简单小巧的3D可视化图形建模工具，可以简单的使用各种点、线面等基本图形元素组合建立模型，并进行贴图，分组。进一步的，该工具还支持简单的骨骼动画制作，是一款非常好用的3D图形构建工具。</p>

<p>[<img class="alignnone  wp-image-125" src="http://blog.sword865.com/wp-content/uploads/2015/02/ms3d-300x164.jpg" alt="ms3d" width="428" height="234" />][1]</p>

<p>在建立了MS3D中完成模型建立后可保存为.ms3d的文件格式，通过对该文件格式进行分析，就可以了解文件结构，以在程序中通过读取该文件重现所见模型。</p>

<p>该文件依次包括6段信息，除第一段文件头外，其它每段的开始位置都记录了该段中元素的数目，可用于计算该段的具体大小。</p>

<ul>
<li><p>文件头:大小固定为14字节。前10个字节为固定的标志 MS3D000000&lt;-其中后6个字节就是字符0（即值为48）后4个字节为该模型格式的版本号，这4个字节为一个有符号整数，目前该版本号的值为3或4，两种版本的格式细节不同。</p></li>

<li><p>点数据：紧接着文件头的就是模型的顶点数据部分，顶点部分的头两个字节为一个无符号整数，表示有多少个顶点。之后便是一个接一个的顶点的具体数据，包括可见性，x,y,z的坐标和绑定骨骼的ID编号(未绑定骨骼则为-1)。</p></li>

<li><p>多边形数据: 紧接着顶点数据的是多边形数据（三角形），多边形部分头两个字节是一个无符号整数，表示有多少个三角形。之后便是一个接一个的三角形数据。主要记录了每个三角形结构，包括顶点索引，顶点法线（用于光照计算），纹理坐标和组信息。</p></li>

<li><p>组信息：即网格信息，出于灵活性的考虑，模型的一个个三角形被按照网格或是组来划分。网格部分头两个字节是一个无符号整数，表示有得多少个网格。之后便是一个接一个的网格数据，每个网格结构的大小可能不同（因为他们拥有的三角形数不同）。主要包括网格的名字（字符串），三角形数量、三角形索引和材质索引（无材质则为-1）。</p></li>

<li><p>材质信息：贴图、颜色等材质部分。头两个字节是一个无符号整数，表示有多少个材质。之后便是一个接一个的材质信息。包括材质名、环境光、漫射光、高光、自发光、发光值、透明度、贴图文件名、透明贴图文件名。</p></li>

<li><p>骨骼信息： 动画、动作等。该结构是MS3D中的动态结构，仅当建立动态动画时存在，包括一种名为关键帧的结构，记录时间与对应的坐标系变换。骨骼信息，一开始是两个字节的无符号整数，表示一共有多少个骨骼，之后便是一个个的骨骼，骨骼的大小不是固定的。主要包括了骨骼名字，父骨骼名字，初始旋转与初始平移、以及之后的各个旋转与平移关键帧。</p></li>
</ul>

<p>在分析了解了MS3D的文件格式后，就可以通过编写程序读取MS3D文件并根据该文件建立模型了，对应于MS3D的不同分段，可以依次建立6种结构体分别对应每段内容：</p>

<p>MS3DHeader     /*包含ms3d文件的版本信息*</p>

<p>MS3DVertex     /*顶点信息*/</p>

<p>MS3DMaterial   /*材质(纹理贴图等)信息*/</p>

<p>MS3DTriangle   /*绘制三角形信息*/</p>

<p>MS3DJoint      /*节点(骨骼)信息*/</p>

<p>MS3DKeyframe   /*关键窗口*/</p>

<p>如：</p>

<pre class="lang:c++ decode:true" title="点结构">struct MS3DVertex
{
  unsigned char m_ucFlags;   //编辑器用标志
  CVector3 m_vVert;        //x,y,z的坐标
  char m_cBone;        //Bone ID （-1 ,没有骨头）
  unsigned char m_mcUnused;      //保留，未使用
};</pre>

<p>&nbsp;</p>

<p>(1)第一个成员表示了该顶点在编辑器中的状态（引擎中不是必须）其各个值的含义如下：</p>

<p>0：顶点可见，未选中状态</p>

<p>1：顶点可见，选中状态</p>

<p>2：顶点不可见，未选中状态</p>

<p>3：顶点不可见，选中状态</p>

<p>(2)第二个成员为顶点的坐标，CVector3为三个float型组成，总共12字节</p>

<p>(3)第三个成员为该顶点所绑定的骨骼的ID号，如果该值为-1 则代表没有绑定任何骨骼（静态）</p>

<p>(4)第四个成员不包含任何信息，直接略过。</p>

<p>将MS3D各段内容分别导入对应的结构体，将其读入内存。</p>

<p>多边形（三角形）结构读取示范：</p>

<pre class="lang:c++ decode:true">//内存空间分配
// pPtr为文件读取偏移指针
int nTriangles = *( word* )pPtr;
m_numTriangles = nTriangles;
m_pTriangles = new Triangle[nTriangles];
pPtr += sizeof( word );
//读取每个三角型
for ( i = 0; i &lt; nTriangles; i++ )
{
  MS3DTriangle *pTriangle = ( MS3DTriangle* )pPtr;
  int vertexIndices[3] = { pTriangle-&gt;m_vertexIndices[0], pTriangle-&gt;m_vertexIndices[1], pTriangle-&gt;m_vertexIndices[2] };
  float t[3] = { 1.0f-pTriangle-&gt;m_t[0], 1.0f-pTriangle-&gt;m_t[1], 1.0f-pTriangle-&gt;m_t[2] };
  //数据读取
  memcpy( m_pTriangles[i].m_vertexNormals, pTriangle-&gt;m_vertexNormals, sizeof( float )*3*3 );
  memcpy( m_pTriangles[i].m_s, pTriangle-&gt;m_s, sizeof( float )*3 );
  memcpy( m_pTriangles[i].m_t, t, sizeof( float )*3 );
  memcpy( m_pTriangles[i].m_vertexIndices, vertexIndices, sizeof( int )*3 );
  //文件读取指针前进
  pPtr += sizeof( MS3DTriangle );
}
</pre>

<p>&nbsp;</p>

<p>要注意得是，因为MS3D使用窗口坐标系而OpenGL使用笛卡儿坐标系，所以需要反转每个顶点Y方向的纹理坐标</p>

<p>除了读取模型信息外，还需要根据材质信息段中各种材质的贴图文件路径，读入对应的贴图文件，用以完成贴图。</p>

<p>通过对上一步中得到的各种结构体进行解析，可以得到以下以一些简单的基础结构：</p>

<p>Mesh   /*网格*/</p>

<p>Material  /*材质*/</p>

<p>Triangle  /*三角形*/</p>

<p>Vertex   /*定点*/</p>

<p>不同于以上结构体严格对应了MS3D各段存储结构，这些结构体仅仅包含了简单的图形信息，非常方便之后的绘制操作。</p>

<p>在读入MS3D文件后，可以使用OPENGL函数根据读入的数据与模型的信息，按网格分组，分别绘制每一组的数据。</p>

<pre class="lang:c++ decode:true ">//按网格分组绘制
for ( int i = 0; i &lt; m_numMeshes; i++ )
{
  //材质，贴图等
  ………………………
  //开始绘制多边形（三角形）
  glBegin( GL_TRIANGLES );
  {
    for ( int j = 0; j &lt; m_pMeshes[i].m_numTriangles; j++ ){
    ……………………….
    //三角形所有顶点绘制
    for ( int k = 0; k &lt; 3; k++ )
    {
      //单个点的绘制
      ………………….
    }
  }
  glEnd();
}</pre>

<p>&nbsp;</p>

<p>通过这种方法，就可以在程序中绘制一个个的具体模型：</p>

<p><img class="alignnone  wp-image-127" src="http://blog.sword865.com/wp-content/uploads/2015/02/ballfight-300x168.jpg" alt="ballfight" width="352" height="197" /></p>

<p>&nbsp;</p>

<p>[1]<a href="http://blog.sina.com.cn/s/blog_62d98a550100g5hh.html">http://blog.sina.com.cn/s/blog_62d98a550100g5hh.html</a></p>

<p>[2]<a href="http://www.yakergong.net/nehe/course/tutorial_31.html">http://www.yakergong.net/nehe/course/tutorial_31.html</a></p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="http://blog.sword865.com/archives/13" title="算法总结9—优化">
      Previous
    </a>
    

    
    <a class="next" href="http://blog.sword865.com/archives/12" title="R语言系列—回归分析">
      Next
    </a>
    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  
  

	<div class="ds-thread" data-thread-key="/archives/124" data-title="简单讲一下使用MS3D为opengl建模" data-url="http://blog.sword865.com/archives/124"></div>


<script type="text/javascript">
var duoshuoQuery = {short_name:"sword865"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>



</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <div>
  友情链接 -
  
<a href="http://brg-liuwei.github.io/">Blog of Finesse</a>

<a href="http://blog.sina.com.cn/hkingstar">霄星座</a>

<a href="http://blog.sina.com.cn/williamwhe">威廉他</a>


</div>

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  
<div class="container copyright">
  
  Copyright &copy; 2015. All rights reserved.


</div>


</div>

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
    },
  TeX: {
              equationNumbers: {
                  autoNumber: ["AMS"],
                  useLabelIds: true
              }
          },
          "HTML-CSS": {
              linebreaks: {
                  automatic: true
              },
              scale: 85
          },
          SVG: {
              linebreaks: {
                  automatic: true
              }
          }
  });
  </script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</footer>

    </main>
    


<script src="http://blog.sword865.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>





<script src="https://s95.cnzz.com/z_stat.php?id=1260888787&web_id=1260888787" language="JavaScript"></script>



    
  </body>
</html>

